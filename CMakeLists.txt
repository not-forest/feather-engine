# Main project MakeLists.txt file.
cmake_minimum_required(VERSION 3.15)
project(feather C)

add_compile_definitions(PROJECT_ROOT_PATH="${CMAKE_SOURCE_DIR}")

# Required external libraries.
find_package(SDL REQUIRED)
find_package(cglm REQUIRED)
find_package(tllist REQUIRED)

# Internal include headers.
include_directories(feather PUBLIC include)
file(GLOB_RECURSE SRCS src/*.c)
add_library(feather ${SRCS})

target_link_libraries(feather PRIVATE SDL::SDL tllist::tllist cglm::cglm)
file(GLOB_RECURSE HEADER_FILES "${CMAKE_CURRENT_SOURCE_DIR}/include/*.h")
set_target_properties(feather PROPERTIES PUBLIC_HEADER "${HEADER_FILES}")

# Locates the .config file generated by menuconfig
set(CONFIG_FILE "${CMAKE_CURRENT_SOURCE_DIR}/.config")
if(EXISTS ${CONFIG_FILE})
    message(STATUS "Found configuration file: ${CONFIG_FILE}")
    file(READ ${CONFIG_FILE} CONFIG_CONTENT)
    string(REGEX MATCHALL "^CONFIG_[A-Z0-9_]+=[^\n]+" CONFIG_LINES "${CONFIG_CONTENT}")
    
    foreach(CONFIG_LINE ${CONFIG_LINES})
        string(REGEX REPLACE "CONFIG_([A-Z0-9_]+)=(.*)" "\\1" CONFIG_NAME "${CONFIG_LINE}")
        string(REGEX REPLACE "CONFIG_([A-Z0-9_]+)=(.*)" "\\2" CONFIG_VALUE "${CONFIG_LINE}")

        if(CONFIG_VALUE MATCHES "^\".*\"$")
            string(REGEX REPLACE "\"([^\"]+)\"" "\\1" CONFIG_VALUE ${CONFIG_VALUE})
        endif()
        message(STATUS "Defining: ${CONFIG_NAME}=${CONFIG_VALUE}")
        add_compile_definitions(${CONFIG_NAME}=${CONFIG_VALUE})
    endforeach()
else()
    message(WARNING "No configuration file found: ${CONFIG_FILE}")
endif()

message(STATUS "Engine's version: ${PROJECT_VERSION}")

install(DIRECTORY ${CMAKE_SOURCE_DIR}/shaders DESTINATION ${CMAKE_INSTALL_PREFIX}/shaders)
install(TARGETS feather)
